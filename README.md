# Telegram-бот для аналитики по видео на основе задач на естественном языке

### Контекст
Сервис хранит две таблицы:
- итоговую статистику по каждому видео (просмотры, лайки, комментарии и т.д.);
- почасовые «снапшоты» статистики по каждому видео (чтобы отслеживать динамику).

Необходимо сделать Telegram-бота, который умеет по запросу на естественном языке считать нужные метрики по этим данным.

**Stack:** aiogram, PostgreSQL, ollama::qwen2.5:7b, Docker

### Запуск

#### Создание контейнеров 
Для запуска используются images: PostgreSQL, Ollama. Для локального развертывания модели требуется минимум 11 Гб оперативной памяти.

Скачивание и запуск контейнеров:
```
> docker-compose up -d
```

Скачивание модели локально:
```
> docker exec -it code-ollama ollama run qwen2.5:7b
```

#### Создание таблиц и загрузка данных
Файлы скриптов формирования таблиц и загрузки данных из JSON-файла находятся в папке **migration**.

1. Формирование таблиц происходит из pgAdmin при подключении к БД и выполнении содержимого файла **init_table.sql**.
2. Миграция данных. Команда из docker-контейнера:
```
python -m migration.load_json
```

### Преобразование запроса в SQL
Запрос передается на локально запущенную модель Ollama::qwen2.5:7b, которая формирует SQL-запрос по промпту, который расположен по пути: app.ollama_handler.

### Пример файла с переменными окружения
```
LLM_URI=http://localhost:11434/api/generate
DB_URI=postgresql://postgres:secret@localhost:5432/demo
BOT_TOKEN=<токен телеграм-бота>
POSTGRES_USER=postgres
POSTGRES_PASSWORD=secret
POSTGRES_DB=demo
```